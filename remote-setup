#
# File: remote-setup
#
# Purpose: Script run on remote Wiki hosting computer
#

# Update APT cache
sudo apt-get update

# Install Nginx
sudo apt-get install -y -qq nginx

# Start the Nginx service
sudo service nginx start

# Install PHP support
sudo apt-get install -y -qq php5-fpm php5-gd

# Handle either case
sudo sed  -i 's/;cgi.fix_pathinfo=0/cgi.fix_pathinfo=1/'  /etc/php5/fpm/php.ini
sudo sed  -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=1/'  /etc/php5/fpm/php.ini


sudo service php5-fpm restart

# Overwrite the current default configuration
sudo cp nginx-config /etc/nginx/sites-available/default

# Certbot install
git clone https://github.com/certbot/certbot

# Make directories for Certbot state/information
mkdir -p cert-config
mkdir -p cert-work
mkdir -p cert-log

cd certbot

letsencrypt-auto-source/letsencrypt-auto --os-packages-only

# Put us in the right 'environment'
tools/venv.sh

certbot certonly --manual  -d SERVER_DOMAIN_NAME --config-dir cert-config --work-dir cert-work --logs-dir cert-log
